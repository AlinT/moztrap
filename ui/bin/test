#!/usr/bin/env python
"""
Run the tests for this project using unittest2 test discovery. This is
essentially equivalent to running ``unit2 discover``, it just allows us to set
up the path and settings environment (and measure coverage).

"""
import os, sys

import coverage
from unittest2.main import main as unittest_main


def main():
    cov = coverage.coverage(branch=True)
    cov.start()
    ut = unittest_main(module=None, exit=False)
    cov.stop()
    cov.html_report(include=["tcmui/*"], directory="coverage")


if __name__ == "__main__":
    sys.path.insert(0, os.path.dirname(os.path.dirname(__file__)))
    if os.environ.get("DJANGO_SETTINGS_MODULE", None) is None:
        os.environ["DJANGO_SETTINGS_MODULE"] = "tests.settings"

    # if a particular test module / suite / case is not specified,
    # do discovery by default
    if not [a for a in sys.argv[1:] if not a.startswith("-")]:
        sys.argv[1:1] = ["discover"]

    main()
