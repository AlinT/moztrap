#!/usr/bin/env python
"""
Run the tests for this project using unittest2 test discovery. This is
essentially equivalent to running ``unit2 discover``, it just allows us to set
up the path and settings environment (and measure coverage).

"""
import os, sys

import coverage
from unittest2.main import main as unittest_main


def main(basedir, cover_all=False):
    cov = coverage.coverage(branch=True)
    cov.start()
    ut = unittest_main(module=None, exit=False)
    cov.stop()

    report_kw = {"directory": "coverage"}
    if cover_all:
        # include all python modules under tcmui in report, including even those
        # the tests don't cause to be imported at all yet, so as to get a more
        # accurate overall coverage figure.
        py_files = []
        for dirpath, dirs, filenames in os.walk(os.path.join(basedir, "tcmui")):
            py_files.extend([os.path.join(dirpath, fn)
                             for fn in filenames if fn.endswith(".py")])
        report_kw["morfs"] = py_files
    else:
        report_kw["include"] = ["tcmui/*"]
    cov.html_report(**report_kw)


if __name__ == "__main__":
    basedir = os.path.dirname(os.path.dirname(__file__))
    sys.path.insert(0, basedir)
    if os.environ.get("DJANGO_SETTINGS_MODULE", None) is None:
        os.environ["DJANGO_SETTINGS_MODULE"] = "tests.settings"

    # if a particular test module / suite / case is not specified,
    # do discovery by default
    if not [a for a in sys.argv[1:] if not a.startswith("-")]:
        sys.argv[1:1] = ["discover"]

    # support an additional option, --cover-all, for a fuller coverage report
    cover_all = False
    if "--cover-all" in sys.argv:
        sys.argv.remove("--cover-all")
        cover_all = True

    main(basedir, cover_all)
