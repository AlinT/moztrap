{% extends 'test/manage_base.html' %}

{% block crumb %}
  {{ block.super }}
  <li><a href="/manage/testcase/add/">add test case</a></li>
{% endblock crumb %}

{% block content %}
<section id="create">
  <h2>create a new test case</h2>
  <form method="POST">
    {% csrf_token %}
    <ul class="meta">
      <li>
        {{ form.name.errors }}
        {{ form.name.label_tag }}
        {{ form.name }}
      </li>
      <li>
        {{ form.product.errors }}
        {{ form.product.label_tag }}
        {{ form.product }}
      </li>
      <li>
        {{ form.tags.errors }}
        {{ form.tags.label_tag }}
        {{ form.tags }}
      </li>
    </ul>

    <div class="env">
      <h3>Environment Constraints</h3>
      {{ form.env_formset.management_form }}
      <ul class="envlist">
        {% for envform in form.env_formset %}
        <li>
          <ul>
            <li>
              {{ envform.env_type.errors }}
              {{ envform.env_type.label_tag }}
              {{ envform.env_type }}
            </li>
            <li>
              {{ envform.environments.errors }}
              {{ envform.environments.label_tag }}
              {{ envform.environments }}
            </li>
          </ul>
        </li>
        {% endfor %}
      </ul>
    </div>

    <div class="steps">
      {{ form.steps_formset.management_form }}
      {% for stepform in form.steps_formset %}
      <ol class="steplist">
        <li>
          <div class="action">
            {{ stepform.instruction.errors }}
            {{ stepform.instruction.label_tag }}
            {{ stepform.instruction }}
          </div>
          <div class="result">
            {{ stepform.expected_result.errors }}
            {{ stepform.expected_result.label_tag }}
            {{ stepform.expected_result }}
          </div>
        </li>
        {% endfor %}
      </ol>
    </div>

    <div class="form-actions">
      <button type="submit">save test case</button>
    </div>

  </form>

  <ul id="empty-env-form" class="empty-form" style="display: none">
    {% with form.env_formset.empty_form as envform %}
      <li>
        <ul>
          <li>
            {{ envform.env_type.errors }}
            {{ envform.env_type.label_tag }}
            {{ envform.env_type }}
          </li>
          <li>
            {{ envform.environments.errors }}
            {{ envform.environments.label_tag }}
            {{ envform.environments }}
          </li>
        </ul>
      </li>
    {% endwith %}
  </ul>

  <ul id="empty-step-form" class="empty-form" style="display: none">
    {% with form.steps_formset.empty_form as stepform %}
      <li>
        <div class="action">
          {{ stepform.instruction.errors }}
          {{ stepform.instruction.label_tag }}
          {{ stepform.instruction }}
        </div>
        <div class="result">
          {{ stepform.expected_result.errors }}
          {{ stepform.expected_result.label_tag }}
          {{ stepform.expected_result }}
        </div>
      </li>
    {% endwith %}
  </ul>

</section>
{% endblock content %}


{# @@@ move the classes into the markup #}

{% block extrajs %}
<script type="text/javascript">
  $(function() {
    $('ol.steplist > li').formset({
      prefix: '{{ form.steps_formset.prefix }}',
      formTemplate: '#empty-step-form > li',
      formCssClass: 'steps-form',
      deleteCssClass: 'remove',
      deleteText: 'remove',
      deleteOnlyNew: true,
      addCssClass: 'add',
      addText: 'add a step »'
    });
    $('ul.envlist > li').formset({
      prefix: '{{ form.env_formset.prefix }}',
      formTemplate: '#empty-env-form > li',
      formCssClass: 'env-form',
      deleteCssClass: 'remove',
      deleteText: 'remove',
      addCssClass: 'add',
      addText: 'add a constraint »'
    });
  })
</script>

{% endblock %}
